–°–≤—è–∑—å **–º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º** (Many-to-Many) –æ–∑–Ω–∞—á–∞–µ—Ç:
–æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å —Ç–∞–±–ª–∏—Ü—ã A –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å–æ –º–Ω–æ–≥–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏ —Ç–∞–±–ª–∏—Ü—ã B (–æ–¥–∏–Ω –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥).  
–ò –Ω–∞–æ–±–æ—Ä–æ—Ç: –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –º–æ–¥–µ–ª–∏ B –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å–æ –º–Ω–æ–≥–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏ —Ç–∞–±–ª–∏—Ü—ã A.  
(–û–î–ò–ù –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ú–ù–û–ì–û –∫–Ω–∏–≥, –∞ –û–î–ù–ê –∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ú–ù–û–ì–û –∞–≤—Ç–æ—Ä–æ–≤).


## üîß Django: –∫–∞–∫ –∑–∞–¥–∞—Ç—å —Å–≤—è–∑—å many-to-many?

–í Django —Ç–∞–∫–∞—è —Å–≤—è–∑—å —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –ø–æ–ª—è `ManyToManyField`,   
–∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –í –õ–Æ–ë–û–ô (–ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç–æ!!!) –∏–∑ –º–æ–¥–µ–ª–µ–π,  
–∏ Django —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —è–≤–Ω–æ).

---

### üîπ –ú–æ–¥–µ–ª–∏

```python
class Genre(models.Model):
    name = models.CharField(max_length=100, unique=True)

class Book(models.Model):
    title = models.CharField(max_length=200)
    year_published = models.IntegerField()
    genres = models.ManyToManyField(Genre, related_name='books')
```

---

## –ò—Ç–∞–∫, –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º —ç—Ç—É –∫–ª—é—á–µ–≤—É—é –∏–¥–µ—é:

`ManyToManyField` –º–æ–∂–Ω–æ –æ–±—ä—è–≤–∏—Ç—å –í –õ–Æ–ë–û–ô –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º:   
Django —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –¥–≤—É–º—è –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏.


### üîπ –í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî `ManyToManyField` –≤ `Book` (–Ω–∞—à –ø—Ä–∏–º–µ—Ä –≤—ã—à–µ)

```python
class Genre(models.Model):
    name = models.CharField(max_length=100, unique=True)

class Book(models.Model):
    title = models.CharField(max_length=200)
    year_published = models.IntegerField()
    genres = models.ManyToManyField(Genre, related_name='books')
```

–¢–µ–ø–µ—Ä—å:

* `book.genres.all()` ‚Äî –∂–∞–Ω—Ä—ã –∫–Ω–∏–≥–∏
* `genre.books.all()` ‚Äî –∫–Ω–∏–≥–∏ —ç—Ç–æ–≥–æ –∂–∞–Ω—Ä–∞

---

### üîπ –í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî `ManyToManyField` –≤ `Genre`

```python
class Book(models.Model):
    title = models.CharField(max_length=200)
    year_published = models.IntegerField()

class Genre(models.Model):
    name = models.CharField(max_length=100, unique=True)
    books = models.ManyToManyField(Book, related_name='genres')
```

–¢–µ–ø–µ—Ä—å:

* `genre.books.all()` ‚Äî –∫–Ω–∏–≥–∏ –∂–∞–Ω—Ä–∞
* `book.genres.all()` ‚Äî –∂–∞–Ω—Ä—ã –∫–Ω–∏–≥–∏

–ò–º–µ–Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ `related_name='genres'` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Book`.

---

### ‚ö†Ô∏è –í–∞–∂–Ω–æ: –Ω–µ–ª—å–∑—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑—å

–ù–µ–ª—å–∑—è –æ–±—ä—è–≤–∏—Ç—å `ManyToManyField` –í –û–ë–ï–ò–• –º–æ–¥–µ–ª—è—Ö –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û:

```python
# ‚ùå –û—à–∏–±–∫–∞: –æ–±–µ –º–æ–¥–µ–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç ManyToManyField
class Book(models.Model):
    title = models.CharField(max_length=200)
    genres = models.ManyToManyField(Genre)

class Genre(models.Model):
    name = models.CharField(max_length=100)
    books = models.ManyToManyField(Book)
```

---

## –Ø–≤–Ω–æ–µ (—Ä—É—á–Ω–æ–µ) –∑–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ —Å–≤—è–∑–∏ `ManyToMany`.


### –ö–æ–≥–¥–∞ —ç—Ç–æ –Ω—É–∂–Ω–æ?

–ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ `ManyToManyField` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä:

* –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è** –≤ —Å–≤—è–∑–∫–µ (–¥–∞—Ç–∞, —Ä–æ–ª—å, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Ç.–¥.)
* –Ω—É–∂–µ–Ω **—è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π

–í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä `through=<Model>`.

---

#### –ü—Ä–∏–º–µ—Ä: –ö–Ω–∏–≥–∞, –ñ–∞–Ω—Ä –∏ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

**–ù–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è**:
* –ö–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∂–∞–Ω—Ä–∞–º
* –î–ª—è –∫–∞–∂–¥–æ–π —Å–≤—è–∑–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å **–¥–∞—Ç—É –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –∂–∞–Ω—Ä–∞**

---

##### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

```python
from django.db import models

class Genre(models.Model):
    name = models.CharField(max_length=100, unique=True)

class Book(models.Model):
    title = models.CharField(max_length=200)
    year_published = models.IntegerField()
    
    genres = models.ManyToManyField(
        Genre,
        through='BookGenre',
        related_name='books'
    )

class BookGenre(models.Model):
    book = models.ForeignKey(Book, on_delete=models.CASCADE)
    genre = models.ForeignKey(Genre, on_delete=models.CASCADE)
    assigned_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ('book', 'genre')  # —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
```

---

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å –≤ —ç—Ç–æ —Å–ª—É—á–∞–µ?

```python
# –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã
author, _ = Author.objects.get_or_create(name="–ê—Ä—Ç—É—Ä –ö–æ–Ω–∞–Ω –î–æ–π–ª")
detective, _ = Genre.objects.get_or_create(name="–î–µ—Ç–µ–∫—Ç–∏–≤")
book = Book.objects.create(author=author, title="–°–æ–±–∞–∫–∞ –ë–∞—Å–∫–µ—Ä–≤–∏–ª–µ–π", year_published=1902)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–æ–∂–Ω–æ –¢–û–õ–¨–ö–û —è–≤–Ω–æ –æ–±—Ä–∞—Ç–∏–≤—à–∏—Å—å –∫ –º–æ–¥–µ–ª–∏ BookGenre!!!
# (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Django –¥–ª—è ManyToMany –∑–¥–µ—Å—å —É–∂–µ –Ω–µ –ø–æ–º–æ–≥—É—Ç)
BookGenre.objects.create(book=book, genre=detective)
```
–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É (—Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å –∑–∞–¥–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:

```python
book.genres.set([detective])
```
---

#### ‚ö†Ô∏è –°—É–ø–µ—Ä-–≤–∞–∂–Ω–æ!!!

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `through=BookGenre`:

* –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `book.genres.add(...)` –∏–ª–∏ `set()`
* –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `BookGenre`

---

#### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

1. –ü–æ–ª—É—á–∏—Ç—å –∂–∞–Ω—Ä—ã-–∫–Ω–∏–≥–∏:

```python
book.genres.all()
```

2. –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏-–∂–∞–Ω—Ä—ã:

```python
genre.books.all()
```

3. –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –∂–∞–Ω—Ä–∞:

```python
bg = BookGenre.objects.get(book=book, genre=detective)
print(bg.assigned_at)
```

#### –†–µ–∑—é–º–∏—Ä—É–µ–º:

| –≠–ª–µ–º–µ–Ω—Ç                             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                |
| ----------------------------------- | ----------------------------------------- |
| `ManyToManyField(..., through=...)` | –Ø–≤–Ω–∞—è —Å–≤—è–∑–∫–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π                   |
| –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å (`BookGenre`)  | –•—Ä–∞–Ω–∏—Ç —Å–≤—è–∑–∏ –∏ –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ                |
| `add()`, `set()`                    | –ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç ‚Äî –∑–∞–º–µ–Ω—è—é—Ç—Å—è —è–≤–Ω—ã–º `create()` |

–ö–∞–∫ –≤–∏–¥–∏–º, —è–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–µ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã:
 - —Å–Ω–∏–∂–∞–µ—Ç —É–¥–æ–±—Å—Ç–≤–æ 
 - –∏ —É–º–µ–Ω—å—à–∞–µ—Ç —á–∞—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π,  

–∫–æ—Ç–æ—Ä—ã–µ Django –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –¥–ª—è —Å–≤—è–∑–µ–π —Ç–∏–ø–∞ ManyToManyField.