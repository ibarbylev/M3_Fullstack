# –î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è?

---

## 1. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ QuerySet**

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –≤—ã—á–∏—Å–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä—è–º–æ –≤ –∑–∞–ø—Ä–æ—Å–µ, –∞ –Ω–µ –≤ Python.

### –ü—Ä–∏–º–µ—Ä 1.1: –ü–æ–¥—Å—á—ë—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

```python
from django.db.models import Count
from books.models import Author

authors = Author.objects.annotate(book_count=Count('book'))
for author in authors:
    print(author.name, author.book_count)
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

* `Count('book')` —Å—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥ —Å–≤—è–∑–∞–Ω–æ —Å –∞–≤—Ç–æ—Ä–æ–º.
* –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ–±—ä–µ–∫—Ç `Author` –∫–∞–∫ –Ω–æ–≤–æ–µ –ø–æ–ª–µ `book_count`.

**–¶–µ–ª—å:**
–ò–∑–±–µ–∂–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

---

### –ü—Ä–∏–º–µ—Ä 1.2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π: —Å—Ä–µ–¥–Ω–µ–µ, —Å—É–º–º–∞, –º–∞–∫—Å/–º–∏–Ω

```python
from django.db.models import Avg, Sum, Max

customers = Customer.objects.annotate(
    avg_price=Avg('order__total'),
    total_spent=Sum('order__total'),
    last_order_date=Max('order__created_at')
)
```

**–¶–µ–ª—å:**
–°—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É.

---

## 2. **–°–æ–∑–¥–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π**

–ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä—è–º–æ –≤ SQL.

### –ü—Ä–∏–º–µ—Ä 2.1: –†–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω

```python
from django.db.models import F, ExpressionWrapper, DecimalField

products = Product.objects.annotate(
    discount_amount=ExpressionWrapper(
        F('price') - F('discount_price'),
        output_field=DecimalField()
    )
)
```

**–¶–µ–ª—å:**
–î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–æ–≤–æ–µ –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î —Å —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö DecimalField()

---

### –ü—Ä–∏–º–µ—Ä 2.2: –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —É—Å–ª–æ–≤–∏–µ —á–µ—Ä–µ–∑ `Case` –∏ `When`

```python
from django.db.models import Case, When, Value, CharField

products = Product.objects.annotate(
    price_category=Case(
        When(price__lt=100, then=Value('cheap')),
        When(price__lt=500, then=Value('medium')),
        default=Value('expensive'),
        output_field=CharField()
    )
)
```

**–¶–µ–ª—å:**
–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –ø—Ä—è–º–æ –≤ –∑–∞–ø—Ä–æ—Å–µ.

---

## 3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤**

–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ —á–∞—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.

### –ü—Ä–∏–º–µ—Ä 3.1: –ü–æ–¥—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥

```python
authors = Author.objects.annotate(
    published_books=Count('book', filter=Q(book__is_published=True))
)
```

**–¶–µ–ª—å:**
–°—á–∏—Ç–∞—Ç—å –∏–ª–∏ —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —É—Å–ª–æ–≤–∏—é.

---

### –ü—Ä–∏–º–µ—Ä 3.2: –°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü

```python
from django.utils import timezone
from datetime import timedelta

one_month_ago = timezone.now() - timedelta(days=30)

customers = Customer.objects.annotate(
    recent_spent=Sum('order__total', filter=Q(order__created_at__gte=one_month_ago))
)
```

**–¶–µ–ª—å:**
–ß–∞—Å—Ç–∏—á–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å —É—Å–ª–æ–≤–∏–µ–º.  
(–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ QuerySet customers —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ recent_spent,   
—Å —Å—É–º–º–æ–π –≤—Å–µ—Ö –µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.   
–ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ –±—ã–ª–æ, —Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç None.)

---

## 4. **–†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º**

Django ORM —É–º–µ–µ—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å —á–∞—Å—Ç–∏ –¥–∞—Ç—ã –ø—Ä—è–º–æ –≤ SQL.

### –ü—Ä–∏–º–µ—Ä 4.1: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü—É

```python
from django.db.models.functions import TruncMonth
from sales.models import Order

orders_by_month = Order.objects.annotate(month=TruncMonth('created_at')).values('month').annotate(
    total=Sum('total')
)
```

**–¶–µ–ª—å:**
–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–∞–º.
–ë—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω QuerySet —Å–ª–æ–≤–∞—Ä–µ–π
```python
{
    'month': datetime.date(2025, 8, 1),  # –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    'total': 12345.67                   # —Å—É–º–º–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü
}
```
–≥–¥–µ 
* month ‚Äî –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞, 
* total ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.

---

### –ü—Ä–∏–º–µ—Ä 4.2: –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏

```python
from django.db.models.functions import ExtractWeekDay

sales = Order.objects.annotate(weekday=ExtractWeekDay('created_at'))
```

**–¶–µ–ª—å:**
–î–æ–±–∞–≤–∏—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ —Å –Ω–æ–º–µ—Ä–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏.
(–ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –ø–æ–ª—É—á–∏—Ç –Ω–æ–≤–æ–µ –ø–æ–ª–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏)
---

## 5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤**

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ Python-—Ü–∏–∫–ª.

### –ü—Ä–∏–º–µ—Ä 5.1: –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å

–í–º–µ—Å—Ç–æ:

```python
for author in Author.objects.all():
    author.book_count = author.book_set.count()
```

–ú—ã –¥–µ–ª–∞–µ–º:

```python
Author.objects.annotate(book_count=Count('book'))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
–û–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞.

---

## üóÇ –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ü–µ–ª—è–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

| –¶–µ–ª—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è      | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã                        | –ü—Ä–∏–º–µ—Ä                 |
| -------------------- | ---------------------------------- | ---------------------- |
| –ê–≥—Ä–µ–≥–∞—Ü–∏—è            | `Count`, `Sum`, `Avg`, `Max`       | –ü–æ–¥—Å—á—ë—Ç –∫–Ω–∏–≥ –∞–≤—Ç–æ—Ä–∞    |
| –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è     | `F`, `ExpressionWrapper`           | –†–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω            |
| –£—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞      | `Case`, `When`, `Value`            | –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ü–µ–Ω—ã         |
| –ß–∞—Å—Ç–∏—á–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è  | `filter=` –≤–Ω—É—Ç—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤         | –ü–æ–¥—Å—á—ë—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö |
| –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏      | `TruncMonth`, `ExtractWeekDay`     | –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º     |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ | –õ—é–±—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ + `select_related` | –£–±–∏—Ä–∞–µ–º N+1 –∑–∞–ø—Ä–æ—Å—ã    |


