## –ó–∞—á–µ–º –Ω—É–∂–Ω—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏?

–í Django –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ò–ú–ï–ù–ù–û –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î, –∞ –Ω–µ –≤ Python.  
–≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–æ–º –¥–∞–Ω–Ω—ã—Ö.


| –¢–∏–ø           | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                      |
| ------------- |---------------------------------------------------------------------------------------------------------------|
| **–ê–≥—Ä–µ–≥–∞—Ü–∏—è** | `.aggregate()` - –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –æ–±–æ–±—â—ë–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ QuerySet (`SUM`, `AVG`, `COUNT`, `MAX`, `MIN`)   |
| **–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è** | `.annotate()` - –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ (–≤ —Ç–æ–º —á–∏—Å–ª–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) –ø–æ–ª—è –∫ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –≤ QuerySet |

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞—á:**

* –ü–æ—Å—á–∏—Ç–∞—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ ‚Äî `.aggregate(Count("id"))`
* –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî `.annotate(total=Sum("orders__amount"))`

---

## üîπ –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ SQL (–∞ –Ω–µ –≤ Python)?

### üìå –ü—Ä–∏–º–µ—Ä: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –º–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–æ–≤ –∏ –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–µ–ª–∞—é—â–∏—Ö —ç—Ç–∏ –∑–∞–∫–∞–∑—ã:

```python
class User(models.Model):
    username = models.CharField(max_length=150)
    email = models.EmailField()
    
class Order(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
```

–ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º:
- –∏–∑–≤–ª–µ—á—å —Å—É–º–º—É –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∏ –ø—Ä–æ—Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –≤ Python;
- –Ω–∞–π—Ç–∏ –æ–±—â—É—é —Å—É–º–º—É –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Python

### ‚ùå –í–∞—Ä–∏–∞–Ω—Ç –Ω–∞ Python:

```python
total = sum(order.amount for order in Order.objects.filter(user=user))
```

–≠—Ç–æ—Ç –∫–æ–¥:

* –ó–∞–≥—Ä—É–∂–∞–µ—Ç **–≤—Å–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –≤ –ø–∞–º—è—Ç—å (–º–æ–≥—É—Ç –±—ã—Ç—å —Ç—ã—Å—è—á–∏).
* –î–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –æ–¥–∏–Ω —Ç—è–∂—ë–ª—ã–π —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Python.
* –ü–ª–æ—Ö–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è.

### ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL (–∞–≥—Ä–µ–≥–∞—Ü–∏—è):

```python
from django.db.models import Sum

total = Order.objects.filter(user=user).aggregate(Sum("amount"))["amount__sum"]
```

–≠—Ç–æ—Ç –∫–æ–¥:

* –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å —Å `SUM(amount)`.
* –ë—ã—Å—Ç—Ä–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –°–£–ë–î (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã, –µ—Å–ª–∏ –µ—Å—Ç—å).
* –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ, –±–µ–∑ –ª–∏—à–Ω–µ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## SQL –ø—Ä–æ—Ç–∏–≤ Python

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º:

* 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç 100 000 –∑–∞–∫–∞–∑–æ–≤.
* –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ `amount` –∑–∞–Ω–∏–º–∞–µ—Ç 100 –±–∞–π—Ç –≤ –ø–µ—Ä–µ–¥–∞—á–µ.
* –í–∞—Ä–∏–∞–Ω—Ç –Ω–∞ Python –ø–µ—Ä–µ–¥–∞—ë—Ç 100 000 √ó 100 –±–∞–π—Ç = **\~10 MB** –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞.
* SQL-–∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ–¥–Ω–æ —á–∏—Å–ª–æ** (–Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–π—Ç).

**–í—ã–≤–æ–¥**:

* –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤ SQL —Å–Ω–∏–∂–∞—é—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ø–∞–º—è—Ç—å –∏ —Å–µ—Ç—å.
* –û–Ω–∏ **–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ**.
* –û–Ω–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã –∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é.

---

## üîπ –ü—Ä–∏–º–µ—Ä —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π

–ü–æ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

```python
from django.db.models import Sum

User.objects.annotate(total_spent=Sum("order__amount"))
```

–ê–Ω–∞–ª–æ–≥ –≤ Python:

```python
for user in User.objects.all():
    user.total_amount_by_user = sum(order.amount for order in user.order_set.all())
```

‚ö† –≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ **N+1 –ø—Ä–æ–±–ª–µ–º–µ**:  
1 –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ **N** –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∑–∞–∫–∞–∑—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 

‚úÖ –° –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π –±—É–¥–µ—Ç –¢–û–õ–¨–ö–û –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å —Å `GROUP BY`.

```python
from django.db.models import Sum

# –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª–µ total_amount_by_user, —Ä–∞–≤–Ω–æ–µ —Å—É–º–º–µ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
User.objects.annotate(total_amount_by_user=Sum("order__amount"))
```

```sql
SELECT 
    auth_user.id, 
    auth_user.username, 
    auth_user.email,
    SUM(app_order.amount) AS total_amount_by_user
FROM auth_user
LEFT OUTER JOIN app_order ON app_order.user_id = auth_user.id
GROUP BY auth_user.id, auth_user.username, auth_user.email;
```
### –ü–æ—á–µ–º—É –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏–¥—ë—Ç –ø–æ —Ç—Ä—ë–º –ø–æ–ª—è–º, –∞ –Ω–µ –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—é `user.id`?

–ü—Ä–∏—á–∏–Ω–∞: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å SQL —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º (–∏ MySQL `ONLY_FULL_GROUP_BY`)

–≠—Ç–æ—Ç —Ä–µ–∂–∏–º —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –≤—Å–µ –ø–æ–ª—è –≤ SELECT, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏,  
–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—ã–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ GROUP BY.

### –ö–∞–∫ –æ—Å—Ç–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É —Ç–æ–ª—å–∫–æ –ø–æ `user.id`?

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .values("id"):

```python
User.objects.values("id").annotate(total=Sum("order__amount"))
```
–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ Django –Ω–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª—è:

```sql
SELECT 
    auth_user.id, SUM(app_order.amount) AS total_amount_by_user
FROM auth_user
LEFT OUTER JOIN app_order ON app_order.user_id = auth_user.id
GROUP BY auth_user.id;
```
---

## üí° –í—ã–≤–æ–¥

> **–ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –≤ Django –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–ª—É SQL:**
>
> * –º–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ Python
> * –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ
> * –≤—ã—à–µ —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
> * –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–∞–º—è—Ç—å –∏ —Å–µ—Ç—å
> * –ª—É—á—à–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞

