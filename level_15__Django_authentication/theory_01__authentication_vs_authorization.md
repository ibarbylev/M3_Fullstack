
# Аутентификация и Авторизация

## 1. Определение терминов

1. **Аутентификация** — это процесс идентификации пользователя, когда система проверяет, 
    совпадают ли введённые пользователем учётные данные (логин/пароль) с теми,  
    что хранятся в базе данных.

Иными словами:
- Пользователь вводит учётные данные (обычно логин и пароль).
- Система ищет пользователя в БД по логину.
- Если пользователь найден, проверяется пароль.
- Если пароль совпадает, пользователь считается аутентифицированным.

Важное уточнение: 
- аутентификация не создаёт пользователя и не выдаёт права 
- она только подтверждает, что это действительно тот пользователь.


2. **Авторизация (Authorization)**
   Это процесс проверки, что пользователь имеет право что-то делать.

**Таким образом:** 
- аутентификация - проверяет (устанавливает) личность, 
- авторизация — определяет:
  - что эта установленная личность может делать
  - и какие конкретно ресурсы (страницы) её доступны.

---


## Процесс аутентификации и авторизации в Django


### 0. Сессия (создание сессионного ключа)

* При **первом запросе** пользователя `SessionMiddleware` проверяет наличие cookie `sessionid`.
* Если его нет:

  1. Генерируется **новый уникальный сессионный ключ**.
  2. В базе `django_session` пока запись **не создаётся** (она появляется только при сохранении чего-то в сессии).
  3. Этот ключ будет отправлен пользователю в ответе (Set-Cookie).

* Таким образом, **любой пользователь (даже анонимный!) имеет сессионный ключ после первого запроса.


### 1. Пользователь вводит логин и пароль

* Пользователь отправляет POST-запрос на `/login/` с `username` и `password`.
* Django использует `authenticate(request, username, password)`:

  * Сравнивает введённый пароль с хешем в базе.
  * Если совпадает → возвращает объект `User`.
  * Если НЕ совпадает → возвращает None.
  * 
---

### 2. Привязка пользователя к сессии

* После успешной аутентификации вызывается `login(request, user)`.
* Что делает `login()`:

  * Использует уже существующий сессионный ключ, созданный `SessionMiddleware` при первом запросе пользователя. 
  * Записывает в сессию 
    * идентификатор пользователя (`_auth_user_id`), 
    * backend аутентификации (`_auth_user_backend`) 
    * и метку времени (`_auth_user_hash`). 
  * Обновляет данные в таблице сессий (`django_session`). 
  * Отправляет (или обновляет) сессионный ключ в куки браузера (обычно `sessionid`).

⚠️
На этом этапе пользователь становится аутентифицированным (его личность подтверждена)   
и может использовать систему прав (is_authenticated, is_staff, permissions).

---

### 3. Каждый последующий запрос

1. Браузер автоматически отправляет cookie `sessionid` вместе с запросом.

2. Django `SessionMiddleware` перехватывает запрос:

   * Извлекает `sessionid`.
   * Ищет сессию в базе.
   * Если сессия существует → связывает с объектом пользователя (`request.user`).

3. `AuthenticationMiddleware`:

   * Проверяет сессию и подставляет `request.user`.
   * Если сессия действительна → `request.user` будет объектом `User`.
   * Если нет сессии → `request.user` будет `AnonymousUser`.
     * ⚠️ Именно благодаря этому механизму:
        * Даже у анонимного пользователя есть сессия и связанный с ней cookie (`sessionid`).
        * Это позволяет, например, интернет-магазину хранить корзину покупок для незарегистрированного пользователя.
        * Когда пользователь решает оформить заказ и проходит регистрацию/логин, то
          * его существующая сессия (и данные корзины) привязываются к конкретному `User`.
  
---

### 4. Авторизация

* На этом этапе Django уже знает, кто пользователь (`request.user`) и какие у него права.
* При доступе к защищённым ресурсам:

  * Декоратор `@login_required` проверяет, что `request.user.is_authenticated`.
  * Декоратор `@permission_required('app.permission')` проверяет права через `request.user.has_perm()`.
  * В CBV используются миксины `LoginRequiredMixin` и `PermissionRequiredMixin`.

---

### 5. Итоговый поток запроса

1. Пользователь отправляет логин/пароль.
2. Django проверяет через `authenticate()`.
3. Если верно → создаётся сессия (`login()`), ключ записывается в cookie.
4. Любой следующий запрос → SessionMiddleware достаёт ключ, AuthenticationMiddleware ставит `request.user`.
5. Авторизация проверяет права пользователя → выдаёт доступ или отказ.

---

```
Пользователь
   |
   | 1. Ввод логина/пароля (POST /login/)
   v
Django View (LoginView / custom view)
   |
   | 2. Проверка аутентификации
   |   user = authenticate(username, password)
   v
Если user верен ---------------------
   |                                   
   | 3. Создание сессии                 
   |   login(request, user)              
   |   -> создаётся session key (или user.id связывается с существующем sessionid)        
   |   -> session записывается в БД      
   |   -> cookie sessionid отправляется в браузер (если не отправлялось ранее)
   v
Дальнейшие запросы пользователя
   |
   | 4. Отправка cookie sessionid вместе с каждым запросом
   v
SessionMiddleware
   |
   | 5. Достаёт sessionid из cookie
   |    -> ищет сессию в базе
   v
AuthenticationMiddleware
   |
   | 6. Устанавливает request.user
   |    - User, если сессия валидна
   |    - AnonymousUser, если нет сессии
   v
Django View / Template / CBV
   |
   | 7. Авторизация (проверка прав)
   |    - @login_required / LoginRequiredMixin
   |    - @permission_required / PermissionRequiredMixin
   |    - user.has_perm(...)
   v
Доступ разрешён / отказано
```







