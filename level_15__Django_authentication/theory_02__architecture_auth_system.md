# Архитектура системы аутентификации и авторизации Django

Django уже имеет мощный встроенный механизм для аутентификации и авторизации пользователей, где уже есть всё необходимое для: 
* управления учётными записями пользователей, 
* проверки логина и пароля, 
* хранения сессий, 
* назначения прав доступа и ограничения действий пользователей. 

Система спроектирована так, чтобы быть расширяемой: 
* можно подключать кастомные модели пользователей, 
* внешние источники авторизации (соцсети, LDAP (корпоративные системы), OAuth / OpenID Connect провайдеры),
* настраивать права и группы, 
* использовать сигналы для событий аутентификации, 
* а также интегрировать токены для API. 

Разработчику не нужно реализовывать базовую безопасность с нуля — уже готовые компоненты, при необходимости,  
легко кастомизируются под конкретные требования проекта.


## 1. Модель пользователя (User)
 
Это центральная сущность системы, которая хранит данные об учётных записях (логин, пароль, email и т. д.).

   * Можно использовать стандартную (`AbstractUser`) или кастомную (`AbstractBaseUser`).
   * Важно сразу продумать, нужна ли кастомизация, так как менять модель на работающем проекте очень сложно.

## 2. Аутентификационные бэкенды

Отвечают за проверку подлинности пользователя и позволяют подключать внешние системы авторизации.

   * Django идёт с `ModelBackend` по умолчанию.
   * Можно добавить бэкенды для авторизации через email, LDAP, соцсети (через **django-allauth**, **social-auth-app-django**).
   * Порядок проверки задаётся в `AUTHENTICATION_BACKENDS`.

## 3. Менеджеры пользователей

Упрощают создание и управление пользователями, обеспечивая единообразие в логике работы с ними.
 
   * Обычно используются `UserManager` с методами `create_user()` и `create_superuser()`.
   * При кастомной модели нужно обязательно переопределять их.

## 4. Middleware

Связывает систему аутентификации с HTTP-запросами и делает информацию о пользователе доступной во вью.

   * Основное – `AuthenticationMiddleware`, оно ставит `request.user`.
   * Работает в связке с `SessionMiddleware`, иначе `request.user` всегда будет `AnonymousUser`.

## 5. Сессии (Sessions)

Механизм, который позволяет Django "помнить" авторизованного пользователя между запросами.
   
   * Можно хранить в **БД** (по умолчанию), в **кэше** (Redis/Memcached), в **cookie** (подписи и шифрование).
   * Важно помнить: ID сессии может быть украден → поэтому часто добавляют привязку к IP или User-Agent.

## 6. Система разрешений и групп (Permissions & Groups)

Определяет, что пользователи могут делать в системе, и позволяет управлять доступом через роли и права.
   
   * `is_staff` → доступ в админку.
   * `is_superuser` → полный доступ, права игнорируются.
   * Можно создавать **кастомные разрешения** в `Meta: permissions = [...]`.
   * Для сложных случаев используют **object-level permissions** (например, через библиотеку **django-guardian**).

## 7. Формы и вью для аутентификации

Обеспечивают готовый функционал для входа, выхода и управления паролями без написания логики с нуля.
   
   * Все стандартные вью можно подключить напрямую в `urls.py`.
   * Для кастомных сценариев (например, логин по email вместо username) — наследование и переопределение форм/вью.
   * Django 2.1+ добавил `LoginRequiredMixin` для ограничения доступа на уровне CBV.

## 8. Сигналы (Signals)

Позволяют выполнять дополнительные действия при событиях аутентификации, например, отправку уведомлений или запись логов.
   
   * Часто используют `user_logged_in`, `user_logged_out`, `user_login_failed` для логирования или уведомлений.

## 9. Пароли и безопасность

Защищает пароли и обеспечивает безопасное хранение и использование учётных данных.

   * Django хранит пароли с помощью PBKDF2 (по умолчанию).
   * Есть встроенные механизмы смены пароля, сброса по email, проверки сложности.
   * Поддерживается настройка `PASSWORD_HASHERS` и ротация алгоритмов.

## 10. Token-based / JWT аутентификация (для API)

Используется для API, где сессии неудобны; токены позволяют клиентам взаимодействовать с сервером без постоянных cookie.

* Django REST Framework (DRF) предоставляет токены.
* Для продакшена чаще используют JWT (через `djangorestframework-simplejwt`).

