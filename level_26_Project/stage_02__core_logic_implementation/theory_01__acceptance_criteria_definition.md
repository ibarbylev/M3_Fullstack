## Определение критериев поведения ядра бизнес-логики (`acceptance criteria definition`)

На предыдущей стадии мы 

* подробно разобрали ТЗ, 
* рассмотрели возможные сценарии (варианты) реализации проекта
* и определили архитектура нашего проекта (приложения / маршруты)

Пришло время начать реализацию проекта.

Удобнее всего начать реализацию проекта с создания БД, для чего мы

1. Опишем (определим) критерии поведения ядра бизнес-логики. И на основе этих критериев:
2. Напишем тесты к будущим методам наших моделей
3. А затем по этим тестам напишем и сам код.

⚠️ Важно:

Мы упрощаем задачу не сверяясь с остатками (подходит для продажи online-продуктов и дропшиппинга).

Поэтому:
1. Мы не отслеживаем доставку, поэтому наш заказ имеет только 3 стадии:
   * `cart` -  `Корзина`
   * `pending` - `Ожидание оплаты`
   * `paid` - `Оплачено`
2. Мы не блокируем остатки на время оформления заказа
3. Мы не отслеживаем доставку клиента (не стадий `shipped` и `delivered`)

---

## 1 Приложение `users`

### UserProfile — персональные данные и баланс

* Хранение данных пользователя: 
  * телефон (`phone`), адрес (`address`), аватар (`avatar`), баланс (`balance DECIMAL(10,2)`).
* Методы:

  * `get_balance(user)` — текущий баланс пользователя
  * `get_cart(user)` — получение корзины пользователя
  * `get_unpaid_orders(user)` — список неоплаченных заказов и суммарная стоимость
* Автоматическое создание корзины при добавлении товара, если она ещё не создана
* Автоматическая очистка корзины, не изменявшейся 7 дней

### UserToken — управление токенами

* Хранение токенов: `token`, `token_type` (`refresh`, `email_verify`, `password_reset`), `expires_at`, `revoked`
* Методы:

  * генерация токена
  * проверка валидности токена
  * отзыв/удаление токена
  * автоматическое удаление истёкших токенов
* Использование токенов для:

  * подтверждения email
  * сброса пароля
  * обновления JWT

---

## 2 Приложение `shop`

### Product — каталог и характеристики

* Хранение товаров: 
  * `name`, `slug`, `description`, `price`, `unit`, `category_id`, `image`, `specs (JSON)`, `is_active`, `stock`
* Методы:

  * получение списка товаров, фильтрация, поиск
  * просмотр детальной информации
  * добавление/редактирование характеристик (`specs`)
  * проверка наличия на складе (`stock`)

### Order и OrderItem — корзина и заказы

* Статусы заказа: `cart`, `pending`, `paid`
* Автоматическое пересчитывание `total_price` при изменении корзины
* Переход корзины в заказ (`cart` → `pending`) при оформлении
* Номер заказа `yyyymmdd__hhmmss__user_id` должен быть уникальным. Если нет, то время увеличивается на 1 сек.
* Привязка товаров через `OrderItem`
* Автоматическая проверка и оплата заказов при наличии баланса
* Автоматическое удаление pending-заказа, не оплаченного в течение 100 дней

### Payment — оплата заказов

* Статусы: `pending`, `completed`, `failed`, `cancelled`
* Совершение оплаты возможно только для статуса заказа `pending` и невозможно для `cart`
* Списание средств с баланса пользователя при оплате
* Автоматическая проверка всех неоплаченных заказов при пополнении баланса

### Review — отзывы

* Пользователь может оставлять отзыв на товар: `rating 1–5`, `comment`
* Методы:

  * добавление и просмотр отзывов
  * проверка связи отзыва с товаром и пользователем

---

# Сводка для тестирования (TDD)

| Приложение | Объект            | Основные сценарии                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ---------- | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `users`    | UserProfile       | - Баланс, пополнение и списание средств<br>- Корректное создание корзины при первом добавлении товара<br>- Автоматическая очистка корзины старше 7 дней<br>- Получение неоплаченных заказов (`get_unpaid_orders`) с корректной суммой<br>- Проверка метода `get_balance(user)`                                                                                                                                                                                                                               |
| `users`    | UserToken         | - Создание токена заданного типа (`refresh`, `email_verify`, `password_reset`)<br>- Проверка валидации токена (валидный/истёкший/отозванный)<br>- Отзыв и удаление токена<br>- Автоматическое удаление истёкших токенов<br>- Связь токена с пользователем                                                                                                                                                                                                                                                    |
| `shop`     | Product           | - Каталог, фильтры, поиск по `name`, `category_id`, `price` и `specs` (JSON)<br>- Проверка наличия на складе (`stock`) при добавлении в корзину<br>- Добавление/редактирование характеристик (`specs`)                                                                                                                                                                                                                                                                                                       |
| `shop`     | Order / OrderItem | - Автоматическое пересчитывание `total_price` при изменении корзины (добавление/удаление/изменение количества)<br>- Переход корзины в заказ (`cart` → `pending`), проверка правильного формирования номера заказа (`дата__время__user_id`)<br>- Привязка товаров через `OrderItem`<br>- Автоматическая проверка и оплата заказов при наличии баланса<br>- Автоматическое удаление заказов в статусе `pending` старше 100 дней<br>- Проверка корректной работы сигналов `update_order_total` и `auto_payment` |
| `shop`     | Payment           | - Оплата возможна только для заказов в статусе `pending`, невозможно для `cart`<br>- Проверка генерации номера инвойса (`yyyymmdd_hhmmss_user_id`) при переходе заказа в `paid`<br>- Списание средств с баланса пользователя<br>- Автоматическая проверка и оплата всех неоплаченных заказов при пополнении баланса<br>- Проверка корректной работы сигналов `check_auto_payment` при создании новых `Payment`                                                                                               |
| `shop`     | Review            | - Добавление и просмотр отзывов<br>- Проверка связи отзыва с товаром и пользователем                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `system`   | Signals & Jobs    | - Проверка корректности формирования `order_id` и `invoice_number` по шаблону (`yyyymmdd_hhmmss_user_id`)<br>- Проверка работы сигналов `auto_payment`, `update_order_total`, `check_auto_payment`<br>- Проверка периодической задачи очистки старых заказов (`cleanup_old_pending`) и корзин (`cleanup_old_carts`)<br>- Проверка автоудаления истёкших токенов<br>- Проверка восстановления целостности данных после исключений в сигналах (например, при ошибке списания средств)                          |
